name: test
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        keycloak-version:
          - '13.0.1'
          - '12.0.4'
          - '11.0.3'
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Go
        uses: actions/setup-go@v2
        with:
          go-version: '1.16.5'
      - name: Download module dependencies
        run: go mod download
      - name: Install Terraform
        working-directory: /tmp
        run: |
          curl -LO https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip
          unzip terraform_${TF_VERSION}_linux_amd64.zip
          sudo mv terraform ${TF_ACC_TERRAFORM_PATH}
          which terraform
          terraform version
        env:
          TF_VERSION: '1.0.4'
          TF_ACC_TERRAFORM_PATH: '/usr/local/bin/terraform'
      - name: Initialize Keycloak container
        run: ./scripts/wait-for-local-keycloak.sh && ./scripts/create-terraform-client.sh
      - name: Run Tests
        run: KEYCLOAK_CLIENT_ID=terraform
             KEYCLOAK_CLIENT_SECRET=884e0f95-0f42-4a63-9b1f-94274655669e
             KEYCLOAK_CLIENT_TIMEOUT=5
             KEYCLOAK_REALM=master
             KEYCLOAK_URL="http://localhost:8080"
             make testacc
        timeout-minutes: 3600
    services:
      keycloak:
        image: jboss/keycloak:${{ matrix.keycloak-version }}
        ports:
          - 8080:8080
        env:
          DB_VENDOR: H2
          KEYCLOAK_LOGLEVEL: INFO
          KEYCLOAK_USER: keycloak
          KEYCLOAK_PASSWORD: password
          JAVA_OPTS: "-Dkeycloak.profile.feature.upload_scripts=enabled -Dkeycloak.profile.feature.admin_fine_grained_authz=enabled -Dkeycloak.profile.feature.token_exchange=enabled"
